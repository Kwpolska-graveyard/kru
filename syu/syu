#!/bin/bash
#syu
#Copyright Kwpolska 2011.  Licensed under GPLv3.

#f(01) syuhelp
function syuhelp {
    echo "syu"
    echo "Copyright Kwpolska 2011.  Licensed under GPLv3."
    echo "usage: syu [-h] [-t] [-l] [-o] [-r] [-c] [-a]"
    echo -ne "\nAn update script.  Part of KRU, copyright Kwpolska 2011, licensed"
    echo -e  "under\nGPLv3.\n"
    echo "default behavior: Perform an update (pacman -Syu + packer -Syu)."
    echo "optional arguments:"
    echo "  -h, --help      show this message and exit"
    echo "  -t, --time      update time using NTP and exit"
    echo "  -l, --lock      unlock the pacman databas and exit"
    echo "  -o, --optimize  optimize the pacman database and exit"
    echo "  -r, --reflect   reflect the mirrors"
    echo "  -c, --cron      perform a cron-friendly update (NTP + pacman -Sy)"
    echo "  -a, --noaur     don't use packer while updating."
    exit
}

#f(02) syutime
    function syutime {
    ntpdate pl.pool.ntp.org
}

#f(03) syunlock
function syunlock {
    rm /var/lib/pacman/db.lck
}

#f(04) syureflect
    function syureflect {
    echo "Running reflector."
    echo -n "Finished elements:"
    reflector -c Any > /etc/pacman.d/mirrorlist
    echo -n " Any"
    reflector -p http -c Germany >> /etc/pacman.d/mirrolist
    echo -n " Germany"
    reflector -p http -c United\ States >> /etc/pacman.d/mirrorlist
    echo -n " US"
    reflector -l 5 -p http >> /etc/pacman.d/mirrorlist
    echo -n " latest"
    reflector -f 5 -p http >> /etc/pacman.d/mirrorlist
    echo -n " fastest"
    #time reflector -f 10 -ro /etc/pacman.d/mirrorlist
    echo -e "\nReflecting finished. Updating..."
    pacman -Syyu
    packer -Syyu
    exit
}

#f(05) syuoptimize
function syuoptimize {
    pacman-optimize
}

#f(06) syucron
function syucron {
    ntpdate pl.pool.ntp.org > /dev/null
    pacman -Sy > /dev/null
    exit
}

cycling='true'
while [ $cycling == 'true' ]; do
    case "$1" in
        "-h" | "--help")        syuhelp    ; EXIT=s ;; #f(01)
        "-t" | "--time")        syutime    ; EXIT=y ;; #f(02)
        "-l" | "--lock")        syunlock   ; EXIT=y ;; #f(03)
        "-o" | "--optimize")    syuoptimize; EXIT=y ;; #f(04)
        "-r" | "--reflect")     syureflect ; EXIT=n ;; #f(05)
        "-c" | "--cron")        syucron    ; EXIT=s ;; #f(06)
        "-a" | "--noaur")       syuaur="n" ; EXIT=n ;; #f(na)
        "")                     cycling='false'     ;;
    esac
    shift
done
if [ "$EXIT" == 'y' ]; then exit 0; fi
if [ "$EXIT" == 's' ]; then
    echo "WARNING:  the self-exit did not happen.  This is a bug."
    echo "File an issue at <https://github.com/Kwpolska/kru/issues>."
    exit 1
fi

pacman -Syu
if [ "$syuaur" != "n" ]; then
    packer -Syu
fi
